{% extends "base.html" %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600 rounded-2xl shadow-2xl p-6 text-white card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-medium">Total Tasks</p>
                    <p class="text-4xl font-bold" id="totalTasks">0</p>
                </div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                    <i class="fas fa-tasks text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-emerald-500 via-green-600 to-teal-600 rounded-2xl shadow-2xl p-6 text-white card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-emerald-100 text-sm font-medium">Completed</p>
                    <p class="text-4xl font-bold" id="completedTasks">0</p>
                </div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 via-violet-600 to-purple-700 rounded-2xl shadow-2xl p-6 text-white card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm font-medium">Focus Hours</p>
                    <p class="text-4xl font-bold" id="totalHours">0h</p>
                </div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                    <i class="fas fa-stopwatch text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-orange-500 via-red-500 to-pink-600 rounded-2xl shadow-2xl p-6 text-white card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm font-medium">Productivity</p>
                    <p class="text-4xl font-bold" id="productivityScore">0%</p>
                </div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 gap-8">
        <!-- Focus Time Chart -->
        <div class="glass rounded-2xl p-6 card-hover">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-chart-area mr-3 text-purple-500"></i>Focus Time Trend
                </h3>
                <select id="focusPeriod" class="glass px-4 py-2 border-0 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-purple-500">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                </select>
            </div>
            <div class="w-full h-80">
                <canvas id="focusTimeChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Category Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Task Categories -->
        <div class="glass rounded-2xl p-6 card-hover">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-layer-group mr-3 text-blue-500"></i>Tasks by Category
            </h3>
            <div class="w-full h-64">
                <canvas id="categoryChart" width="300" height="250"></canvas>
            </div>
        </div>

        <!-- Priority Distribution -->
        <div class="glass rounded-2xl p-6 card-hover">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-exclamation-triangle mr-3 text-orange-500"></i>Priority Distribution
            </h3>
            <div class="w-full h-64">
                <canvas id="priorityChart" width="300" height="250"></canvas>
            </div>
        </div>

        <!-- Weekly Heatmap -->
        <div class="glass rounded-2xl p-6 card-hover">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-calendar-week mr-3 text-green-500"></i>Weekly Activity
            </h3>
            <div id="weeklyHeatmap" class="space-y-3">
                <!-- Heatmap will be generated here -->
            </div>
        </div>
    </div>

    <!-- Productivity Insights -->
    <div class="glass rounded-2xl p-6 card-hover">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <i class="fas fa-lightbulb mr-3 text-yellow-500"></i>Productivity Insights
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="insights">
            <!-- Insights will be generated here -->
        </div>
    </div>
</div>

<script>
let analyticsData = {};
let focusTimeChart = null;
let categoryChart = null;
let priorityChart = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    
    // Period change handlers
    document.getElementById('focusPeriod').addEventListener('change', loadAnalytics);
});

function loadAnalytics() {
    Promise.all([
        fetch('/api/analytics').then(r => r.json()),
        fetch('/api/tasks').then(r => r.json())
    ])
    .then(([analytics, tasks]) => {
        analyticsData = { ...analytics, tasks };
        updateOverviewCards();
        renderCharts();
        generateInsights();
    });
}

function updateOverviewCards() {
    const { tasks, total_completed, total_focus_time } = analyticsData;
    
    document.getElementById('totalTasks').textContent = tasks.length;
    document.getElementById('completedTasks').textContent = total_completed || 0;
    document.getElementById('totalHours').textContent = Math.round((total_focus_time || 0) / 60) + 'h';
    
    const productivity = tasks.length > 0 ? Math.round((total_completed / tasks.length) * 100) : 0;
    document.getElementById('productivityScore').textContent = productivity + '%';
}

function renderCharts() {
    renderFocusTimeChart();
    renderCategoryChart();
    renderPriorityChart();
    renderWeeklyHeatmap();
}



function renderFocusTimeChart() {
    const ctx = document.getElementById('focusTimeChart');
    if (!ctx) return;
    
    if (focusTimeChart) {
        focusTimeChart.destroy();
    }
    
    const data = analyticsData.daily_time || [];
    
    focusTimeChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: data.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [{
                label: 'Focus Time (minutes)',
                data: data.map(d => d.total_time),
                backgroundColor: 'rgba(147, 51, 234, 0.8)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function renderCategoryChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    if (categoryChart) {
        categoryChart.destroy();
    }
    
    const tasks = analyticsData.tasks || [];
    
    const categories = tasks.reduce((acc, task) => {
        acc[task.category] = (acc[task.category] || 0) + 1;
        return acc;
    }, {});
    
    categoryChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(147, 51, 234, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(249, 115, 22, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function renderPriorityChart() {
    const ctx = document.getElementById('priorityChart');
    if (!ctx) return;
    
    if (priorityChart) {
        priorityChart.destroy();
    }
    
    const tasks = analyticsData.tasks || [];
    
    const priorities = tasks.reduce((acc, task) => {
        const priority = task.priority === 3 ? 'High' : task.priority === 2 ? 'Medium' : 'Low';
        acc[priority] = (acc[priority] || 0) + 1;
        return acc;
    }, {});
    
    priorityChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: {
            labels: Object.keys(priorities),
            datasets: [{
                data: Object.values(priorities),
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function renderWeeklyHeatmap() {
    const container = document.getElementById('weeklyHeatmap');
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    // Generate sample heatmap data
    const heatmapData = days.map(day => ({
        day,
        intensity: Math.floor(Math.random() * 5) + 1
    }));
    
    container.innerHTML = heatmapData.map(({ day, intensity }) => `
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600 w-8">${day}</span>
            <div class="flex space-x-1">
                ${Array.from({length: 7}, (_, i) => `
                    <div class="w-3 h-3 rounded-sm ${i < intensity ? 'bg-green-500' : 'bg-gray-200'}"></div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function generateInsights() {
    const { tasks, daily_tasks, daily_time } = analyticsData;
    const insights = [];
    
    // Most productive day
    if (daily_tasks.length > 0) {
        const mostProductiveDay = daily_tasks.reduce((max, day) => 
            day.count > max.count ? day : max
        );
        insights.push({
            icon: 'fas fa-star',
            title: 'Most Productive Day',
            value: new Date(mostProductiveDay.date).toLocaleDateString(),
            description: `${mostProductiveDay.count} tasks completed`,
            color: 'text-yellow-600 bg-yellow-100'
        });
    }
    
    // Average focus time
    if (daily_time.length > 0) {
        const avgFocusTime = Math.round(
            daily_time.reduce((sum, day) => sum + day.total_time, 0) / daily_time.length
        );
        insights.push({
            icon: 'fas fa-clock',
            title: 'Average Focus Time',
            value: `${avgFocusTime} minutes`,
            description: 'per day this week',
            color: 'text-blue-600 bg-blue-100'
        });
    }
    
    // Completion rate
    const completedTasks = tasks.filter(t => t.status === 'completed').length;
    const completionRate = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
    insights.push({
        icon: 'fas fa-percentage',
        title: 'Completion Rate',
        value: `${completionRate}%`,
        description: 'of all tasks completed',
        color: 'text-green-600 bg-green-100'
    });
    
    const insightsContainer = document.getElementById('insights');
    insightsContainer.innerHTML = insights.map(insight => `
        <div class="text-center p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="w-12 h-12 ${insight.color} rounded-lg flex items-center justify-center mx-auto mb-3">
                <i class="${insight.icon} text-xl"></i>
            </div>
            <h4 class="font-semibold text-gray-900 dark:text-white mb-1">${insight.title}</h4>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">${insight.value}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">${insight.description}</p>
        </div>
    `).join('');
}
</script>
{% endblock %}