{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="gradient-border card-hover">
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Tasks</p>
                    <p class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" id="tasksToday">0</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-tasks text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="gradient-border card-hover">
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Completed</p>
                    <p class="text-3xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent" id="completedToday">0</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="gradient-border card-hover">
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Focus Time</p>
                    <p class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent" id="focusTime">0m</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-stopwatch text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="gradient-border card-hover">
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Pending</p>
                    <p class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent" id="pendingTasks">0</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-clock text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2">
        <div class="glass rounded-2xl p-6 card-hover">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-list-check mr-3 text-blue-500"></i>Recent Tasks
            </h3>
            <div id="recentTasks" class="space-y-4">
                <!-- Tasks will be loaded here -->
            </div>
            <div class="mt-6">
                <a href="/tasks" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-semibold group">
                    View all tasks 
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <!-- Quick Pomodoro -->
        <div class="bg-gradient-to-br from-red-500 via-pink-500 to-purple-600 rounded-2xl p-6 text-white card-hover shadow-2xl">
            <div class="flex items-center mb-3">
                <i class="fas fa-tomato text-2xl mr-3 animate-bounce-subtle"></i>
                <h3 class="text-xl font-bold">Quick Pomodoro</h3>
            </div>
            <p class="text-red-100 mb-6 text-sm">Start a focused 25-minute work session</p>
            <a href="/pomodoro" class="inline-flex items-center bg-white/20 backdrop-blur-sm text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/30 transition-all duration-300 group">
                <i class="fas fa-play mr-2 group-hover:scale-110 transition-transform"></i>
                Start Session
            </a>
        </div>

        <!-- Today's Progress -->
        <div class="glass rounded-2xl p-6 card-hover">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-3 text-purple-500"></i>Today's Progress
            </h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">Task Completion</span>
                        <span id="taskProgress" class="font-bold text-gray-900 dark:text-white">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500 ease-out" id="taskProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights -->
<div class="glass rounded-2xl p-6 card-hover mb-8">
    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
        <i class="fas fa-brain mr-3 text-purple-500"></i>ðŸ¤– AI Productivity Coach
    </h3>
    <div id="aiInsights" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- AI insights will be loaded here -->
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="glass rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <i class="fas fa-chart-line mr-3 text-blue-500"></i>Weekly Overview
        </h3>
        <div class="w-full h-64">
            <canvas id="weeklyChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="glass rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <i class="fas fa-stopwatch mr-3 text-purple-500"></i>Focus Time Trend
        </h3>
        <div class="w-full h-64">
            <canvas id="focusChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadRecentTasks();
    loadCharts();
    loadAIInsights();
});

function loadAIInsights() {
    fetch('/api/productivity-insights')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('aiInsights');
            
            const peakHour = data.peak_hours.peak_hour;
            const completionRate = data.completion_patterns.completion_rate;
            const trend = data.completion_patterns.trend;
            
            container.innerHTML = `
                <div class="bg-purple-50 dark:bg-[#3e3e3e] rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-clock text-purple-500 mr-2"></i>
                        <h4 class="font-semibold text-gray-900 dark:text-[#f8f8f2]">Peak Hour</h4>
                    </div>
                    <p class="text-2xl font-bold text-purple-600 dark:text-[#ab9df2]">${peakHour}:00</p>
                    <p class="text-sm text-gray-600 dark:text-[#7e8e91]">Most productive time</p>
                </div>
                
                <div class="bg-green-50 dark:bg-[#3e3e3e] rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-percentage text-green-500 mr-2"></i>
                        <h4 class="font-semibold text-gray-900 dark:text-[#f8f8f2]">Completion Rate</h4>
                    </div>
                    <p class="text-2xl font-bold text-green-600 dark:text-[#a9dc76]">${completionRate}%</p>
                    <p class="text-sm text-gray-600 dark:text-[#7e8e91]">Trending ${trend}</p>
                </div>
                
                <div class="bg-blue-50 dark:bg-[#3e3e3e] rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-lightbulb text-blue-500 mr-2"></i>
                        <h4 class="font-semibold text-gray-900 dark:text-[#f8f8f2]">AI Tip</h4>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-[#c5c8c6]">${data.insights[0] || 'Keep up the great work!'}</p>
                </div>
            `;
        })
        .catch(() => {
            document.getElementById('aiInsights').innerHTML = '<p class="text-gray-500">AI insights will appear after you complete some tasks.</p>';
        });
}

function loadDashboardData() {
    fetch('/api/dashboard-stats')
        .then(response => response.json())
        .then(data => {
            console.log('Dashboard data:', data);
            document.getElementById('tasksToday').textContent = data.tasks_today;
            document.getElementById('completedToday').textContent = data.completed_today;
            document.getElementById('focusTime').textContent = data.focus_time_today + 'm';
            document.getElementById('pendingTasks').textContent = data.pending_tasks;
            
            // Update progress bar
            const progress = data.tasks_today > 0 ? (data.completed_today / data.tasks_today) * 100 : 0;
            document.getElementById('taskProgress').textContent = Math.round(progress) + '%';
            document.getElementById('taskProgressBar').style.width = progress + '%';
        })
        .catch(err => console.error('Dashboard error:', err));
}

function loadRecentTasks() {
    fetch('/api/tasks')
        .then(response => response.json())
        .then(tasks => {
            const recentTasks = tasks.slice(0, 5);
            const container = document.getElementById('recentTasks');
            
            if (recentTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No tasks yet. <a href="/tasks" class="text-blue-600">Create your first task</a></p>';
                return;
            }
            
            container.innerHTML = recentTasks.map(task => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-[#3e3e3e] rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full ${getPriorityColor(task.priority)}"></div>
                        <div>
                            <p class="font-medium text-gray-900 dark:text-[#f8f8f2]">${task.title}</p>
                            <p class="text-sm text-gray-500 dark:text-[#7e8e91]">${task.category}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(task.status)}">${task.status}</span>
                </div>
            `).join('');
        });
}

function getPriorityColor(priority) {
    return priority === 3 ? 'bg-red-500' : priority === 2 ? 'bg-yellow-500' : 'bg-green-500';
}

function getStatusColor(status) {
    return status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
}

function loadCharts() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            // Weekly tasks chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: data.daily_tasks.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Tasks Completed',
                        data: data.daily_tasks.map(d => d.count),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Focus time chart
            const focusCtx = document.getElementById('focusChart').getContext('2d');
            new Chart(focusCtx, {
                type: 'bar',
                data: {
                    labels: data.daily_time.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Focus Time (minutes)',
                        data: data.daily_time.map(d => d.total_time),
                        backgroundColor: 'rgba(147, 51, 234, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        });
}
</script>
{% endblock %}