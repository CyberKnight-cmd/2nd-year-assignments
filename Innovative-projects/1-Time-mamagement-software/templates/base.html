<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block page_title %}TimeFlow{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                        'bounce-subtle': 'bounceSubtle 2s infinite'
                    },
                    backdropBlur: {
                        xs: '2px'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes bounceSubtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .glass {
            backdrop-filter: blur(16px) saturate(180%);
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.125);
        }
        .dark .glass {
            background: rgba(42, 42, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .dark .card-hover:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .gradient-border {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            padding: 2px;
            border-radius: 12px;
        }
        .gradient-border > div {
            background: white;
            border-radius: 10px;
        }
        .dark .gradient-border > div {
            background: #2a2a2a;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen transition-colors duration-300">
    <style>
        .dark body {
            background: #1e1e1e !important;
        }
    </style>
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20 dark:border-[#3e3e3e]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-infinity text-white text-lg"></i>
                        </div>
                        <span class="text-2xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">TimeFlow</span>
                    </div>
                    
                    <div class="hidden md:flex space-x-1">
                        <a href="/" class="nav-link group px-4 py-2 rounded-xl text-gray-700 dark:text-[#c5c8c6] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] hover:text-blue-600 dark:hover:text-[#78dce8] transition-all duration-300 font-medium">
                            <i class="fas fa-home mr-2 group-hover:scale-110 transition-transform"></i>Dashboard
                        </a>
                        <a href="/tasks" class="nav-link group px-4 py-2 rounded-xl text-gray-700 dark:text-[#c5c8c6] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] hover:text-blue-600 dark:hover:text-[#78dce8] transition-all duration-300 font-medium">
                            <i class="fas fa-tasks mr-2 group-hover:scale-110 transition-transform"></i>Tasks
                        </a>
                        <a href="/pomodoro" class="nav-link group px-4 py-2 rounded-xl text-gray-700 dark:text-[#c5c8c6] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] hover:text-blue-600 dark:hover:text-[#78dce8] transition-all duration-300 font-medium">
                            <i class="fas fa-stopwatch mr-2 group-hover:scale-110 transition-transform"></i>Pomodoro
                        </a>
                        <a href="/analytics" class="nav-link group px-4 py-2 rounded-xl text-gray-700 dark:text-[#c5c8c6] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] hover:text-blue-600 dark:hover:text-[#78dce8] transition-all duration-300 font-medium">
                            <i class="fas fa-chart-line mr-2 group-hover:scale-110 transition-transform"></i>Analytics
                        </a>
                        <a href="/goals" class="nav-link group px-4 py-2 rounded-xl text-gray-700 dark:text-[#c5c8c6] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] hover:text-blue-600 dark:hover:text-[#78dce8] transition-all duration-300 font-medium">
                            <i class="fas fa-target mr-2 group-hover:scale-110 transition-transform"></i>Goals
                        </a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" class="p-2 rounded-lg text-gray-600 dark:text-[#c5c8c6] hover:text-blue-600 dark:hover:text-[#78dce8] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] transition-all">
                        <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                    
                    <button class="p-2 rounded-lg text-gray-600 dark:text-[#c5c8c6] hover:text-blue-600 dark:hover:text-[#78dce8] hover:bg-blue-50 dark:hover:bg-[#3e3e3e] transition-all relative">
                        <i class="fas fa-bell"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-[#fc618d] rounded-full"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Floating Timer Widget -->
    <div id="floatingTimer" class="fixed bottom-6 right-6 z-50">
        <div class="glass rounded-2xl shadow-2xl p-4 min-w-[200px]">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-gray-600 dark:text-[#7e8e91]">FOCUS TIME</span>
                <div class="w-2 h-2 bg-red-500 rounded-full" id="timerPulse"></div>
            </div>
            <div class="text-3xl font-bold font-mono text-gray-900 dark:text-[#f8f8f2] mb-3" id="navTimerDisplay">25:00</div>
            <div class="flex gap-2">
                <button onclick="toggleTimer()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-all">
                    <i id="navTimerIcon" class="fas fa-play"></i>
                </button>
                <button onclick="stopTimer()" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:shadow-lg transition-all">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in">
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}{% endblock %}

    <script>
        // Theme
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('themeIcon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark', newTheme === 'dark');
            localStorage.setItem('theme', newTheme);
            initTheme();
        }

        // Timer System
        const Timer = {
            timeLeft: 25 * 60,
            totalTime: 25 * 60,
            isRunning: false,
            interval: null,
            startTime: null,
            currentTask: null,
            
            load() {
                const saved = localStorage.getItem('timer');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.totalTime = data.totalTime;
                    
                    if (data.isRunning && data.startTime) {
                        const elapsed = Math.floor((Date.now() - data.startTime) / 1000);
                        this.timeLeft = Math.max(0, this.totalTime - elapsed);
                        this.startTime = data.startTime;
                        
                        if (this.timeLeft > 0) {
                            this.isRunning = false;
                            this.start();
                        } else {
                            this.complete();
                        }
                    } else {
                        this.timeLeft = data.timeLeft;
                        this.startTime = null;
                    }
                }
                this.updateDisplay();
            },
            
            save() {
                localStorage.setItem('timer', JSON.stringify({
                    timeLeft: this.isRunning ? this.totalTime : this.timeLeft,
                    totalTime: this.totalTime,
                    isRunning: this.isRunning,
                    startTime: this.startTime
                }));
            },
            
            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                if (!this.startTime) {
                    this.startTime = Date.now();
                    this.totalTime = this.timeLeft;
                }
                this.save();
                
                clearInterval(this.interval);
                this.updateDisplay();
                this.interval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    this.timeLeft = Math.max(0, this.totalTime - elapsed);
                    this.updateDisplay();
                    if (this.timeLeft <= 0) this.complete();
                }, 1000);
            },
            
            pause() {
                if (!this.isRunning) return;
                this.isRunning = false;
                this.startTime = null;
                clearInterval(this.interval);
                this.save();
                this.updateDisplay();
            },
            
            stop() {
                if (this.isRunning || this.timeLeft < this.totalTime) {
                    const elapsed = Math.floor((this.totalTime - this.timeLeft) / 60);
                    if (elapsed > 0) this.logTime(elapsed, false);
                }
                
                this.isRunning = false;
                this.startTime = null;
                this.currentTask = null;
                clearInterval(this.interval);
                this.timeLeft = this.totalTime;
                this.save();
                this.updateDisplay();
            },
            
            reset() {
                this.stop();
            },
            
            setTime(minutes) {
                if (this.isRunning) this.pause();
                this.timeLeft = minutes * 60;
                this.totalTime = minutes * 60;
                this.startTime = null;
                this.save();
                this.updateDisplay();
            },
            
            complete() {
                const mins = Math.floor(this.totalTime / 60);
                this.logTime(mins, true);
                
                this.isRunning = false;
                this.startTime = null;
                clearInterval(this.interval);
                this.timeLeft = this.totalTime;
                this.currentTask = null;
                this.save();
                this.updateDisplay();
                
                if (Notification.permission === 'granted') {
                    new Notification('ðŸ… Timer Complete!', { body: `${mins} minutes of focus time completed!` });
                } else {
                    alert('ðŸ… Timer Complete!');
                }
            },
            
            logTime(minutes, completed) {
                const taskId = this.currentTask ? this.currentTask.id : null;
                
                fetch('/api/pomodoro', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: taskId,
                        duration: minutes,
                        completed: completed,
                        start_time: new Date().toISOString(),
                        session_type: 'work'
                    })
                }).then(() => {
                    if (completed && taskId) {
                        fetch(`/api/tasks/${taskId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({status: 'completed'})
                        });
                    }
                }).catch(() => {});
            },
            
            updateDisplay() {
                const mins = Math.floor(this.timeLeft / 60);
                const secs = this.timeLeft % 60;
                const display = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                const navDisplay = document.getElementById('navTimerDisplay');
                const pageDisplay = document.getElementById('timerDisplay');
                const navIcon = document.getElementById('navTimerIcon');
                const pulse = document.getElementById('timerPulse');
                
                if (navDisplay) navDisplay.textContent = display;
                if (pageDisplay) pageDisplay.textContent = display;
                if (navIcon) navIcon.className = this.isRunning ? 'fas fa-pause' : 'fas fa-play';
                if (pulse) pulse.className = this.isRunning ? 'w-2 h-2 bg-red-500 rounded-full animate-pulse' : 'w-2 h-2 bg-gray-400 rounded-full';
                
                const startBtn = document.getElementById('startBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const stopBtn = document.getElementById('stopBtn');
                if (startBtn && pauseBtn && stopBtn) {
                    startBtn.style.display = this.isRunning ? 'none' : 'inline-block';
                    pauseBtn.style.display = this.isRunning ? 'inline-block' : 'none';
                    stopBtn.style.display = this.isRunning ? 'inline-block' : 'none';
                }
                
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('sessionProgress');
                if (progressBar && progressText) {
                    const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }
            }
        };

        function toggleTimer() { Timer.isRunning ? Timer.pause() : Timer.start(); }
        function startTimer() { Timer.start(); }
        function pauseTimer() { Timer.pause(); }
        function stopTimer() { Timer.stop(); }
        function resetTimer() { Timer.reset(); }
        function setTimer(minutes) { Timer.setTime(minutes); }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            Timer.load();
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Keep UI synced
            setInterval(() => {
                if (Timer.isRunning && Timer.startTime) {
                    const elapsed = Math.floor((Date.now() - Timer.startTime) / 1000);
                    Timer.timeLeft = Math.max(0, Timer.totalTime - elapsed);
                    Timer.updateDisplay();
                }
            }, 100);
        });
    </script>
</body>
</html>