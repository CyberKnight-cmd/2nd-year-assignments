{% extends "base.html" %}

{% block page_title %}Tasks{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-[#f8f8f2]">Task Management</h2>
        <p class="text-gray-600 dark:text-[#7e8e91]">Organize and track your tasks</p>
    </div>
    <button id="addTaskBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
        <i class="fas fa-plus mr-2"></i>Add Task
    </button>
</div>

<div id="tasksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<div id="taskModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-[#f8f8f2] mb-4">Add New Task</h3>
        <input type="text" id="taskTitle" placeholder="Task title" class="w-full px-3 py-2 border dark:border-[#3e3e3e] dark:bg-[#1e1e1e] dark:text-[#c5c8c6] rounded-lg mb-3">
        <textarea id="taskDesc" placeholder="Description" class="w-full px-3 py-2 border dark:border-[#3e3e3e] dark:bg-[#1e1e1e] dark:text-[#c5c8c6] rounded-lg mb-3" rows="3"></textarea>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <select id="taskPriority" class="px-3 py-2 border dark:border-[#3e3e3e] dark:bg-[#1e1e1e] dark:text-[#c5c8c6] rounded-lg">
                <option value="1">Low Priority</option>
                <option value="2" selected>Medium Priority</option>
                <option value="3">High Priority</option>
            </select>
            <input type="number" id="taskTime" value="30" min="5" placeholder="Minutes" class="px-3 py-2 border dark:border-[#3e3e3e] dark:bg-[#1e1e1e] dark:text-[#c5c8c6] rounded-lg">
        </div>
        <div class="flex justify-end gap-3">
            <button id="cancelBtn" class="px-4 py-2 text-gray-600 dark:text-[#c5c8c6] hover:text-gray-800">Cancel</button>
            <button id="saveTaskBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">Save</button>
        </div>
    </div>
</div>

<script>
let tasks = [];

document.getElementById('addTaskBtn').onclick = () => {
    document.getElementById('taskModal').style.display = 'flex';
};

document.getElementById('cancelBtn').onclick = () => {
    document.getElementById('taskModal').style.display = 'none';
};

document.getElementById('saveTaskBtn').onclick = () => {
    const title = document.getElementById('taskTitle').value;
    if (!title) return alert('Please enter a task title');
    
    fetch('/api/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            title: title,
            description: document.getElementById('taskDesc').value,
            priority: parseInt(document.getElementById('taskPriority').value),
            estimated_time: parseInt(document.getElementById('taskTime').value),
            category: 'work'
        })
    })
    .then(r => r.json())
    .then(() => {
        document.getElementById('taskModal').style.display = 'none';
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDesc').value = '';
        loadTasks();
    });
};

function loadTasks() {
    fetch('/api/tasks')
        .then(r => r.json())
        .then(data => {
            tasks = data;
            renderTasks();
        });
}

function renderTasks() {
    const container = document.getElementById('tasksContainer');
    container.innerHTML = tasks.map(task => `
        <div class="bg-white dark:bg-[#2a2a2a] rounded-xl shadow-sm p-6 border-l-4 ${task.priority === 3 ? 'border-red-500' : task.priority === 2 ? 'border-yellow-500' : 'border-green-500'}">
            <div class="flex justify-between items-start mb-3">
                <span class="px-2 py-1 text-xs rounded-full ${task.priority === 3 ? 'bg-red-100 dark:bg-[#3e3e3e] text-red-800 dark:text-[#fc618d]' : task.priority === 2 ? 'bg-yellow-100 dark:bg-[#3e3e3e] text-yellow-800 dark:text-[#ffd866]' : 'bg-green-100 dark:bg-[#3e3e3e] text-green-800 dark:text-[#a9dc76]'}">
                    ${task.priority === 3 ? 'High' : task.priority === 2 ? 'Medium' : 'Low'}
                </span>
                <div class="flex gap-2">
                    ${task.status === 'pending' ? `
                        <button onclick="startTask(${task.id}, ${task.estimated_time}, '${task.title}')" class="text-blue-600 dark:text-[#78dce8] hover:text-blue-700">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="completeTask(${task.id})" class="text-green-600 dark:text-[#a9dc76] hover:text-green-700">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button onclick="deleteTask(${task.id})" class="text-red-600 dark:text-[#fc618d] hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-[#f8f8f2] mb-2 ${task.status === 'completed' ? 'line-through opacity-50' : ''}">${task.title}</h3>
            ${task.description ? `<p class="text-gray-600 dark:text-[#7e8e91] text-sm mb-3">${task.description}</p>` : ''}
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500 dark:text-[#7e8e91]"><i class="fas fa-clock mr-1"></i>${task.estimated_time}min</span>
                <span class="px-2 py-1 rounded-full text-xs ${task.status === 'completed' ? 'bg-green-100 dark:bg-[#3e3e3e] text-green-800 dark:text-[#a9dc76]' : 'bg-yellow-100 dark:bg-[#3e3e3e] text-yellow-800 dark:text-[#ffd866]'}">${task.status}</span>
            </div>
        </div>
    `).join('');
}

function startTask(id, time, title) {
    Timer.currentTask = { id: id, title: title, estimated_time: time };
    Timer.setTime(time);
    Timer.start();
    alert(`Started ${time}min timer for: ${title}`);
}

function completeTask(id) {
    fetch(`/api/tasks/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: 'completed'})
    }).then(() => loadTasks());
}

function deleteTask(id) {
    if (confirm('Delete this task?')) {
        fetch(`/api/tasks/${id}`, {method: 'DELETE'})
            .then(() => loadTasks());
    }
}

loadTasks();
</script>
{% endblock %}
